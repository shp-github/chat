<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <title>å®¢æˆ·ç«¯</title>
    <script type="text/javascript" src="static/js/vue.js"></script>

    <script type="text/javascript" src="static/js/jquery.min.js"></script>
    <script type="text/javascript" src="static/js/jquery.slimscroll.min.js"></script>
    <script type="text/javascript" src="static/js/online_chat_js_sdk.js"></script>
    <script type="text/javascript" src="static/js/wangEditor/wangEditor.min.js"></script>
    <script type="text/javascript" src="static/js/face.js"></script>
    <script type="text/javascript" src="static/js/layer/layer.js"></script>
    <link rel="stylesheet" href="static/css/index.css">
</head>

<body style="background:#f5f5f5 url('static/img/bg.jpg') no-repeat center;background-size: cover;">
<div id="app">
    <div class="main">

        <div class="chat-title">
            <p style="float: left">é€‰æ‹©è”ç³»äºº:
                <select id="select" onchange="updateValue()">
                    <option value=''>è¯·é€‰æ‹©è”ç³»äºº</option>
                </select></p>
            <form onSubmit="return false;">
                è¿æ¥å¯¹æ–¹:&nbsp;<input type="text" id="url" name="url" value="è¯·è¾“å…¥é“¾æ¥åœ°å€"/> <br/><br/>
            </form>
        </div>
        <div class="chat-message" id="chat-message">
            <div id="localDiv">


            </div>
            <ul v-if="onlineChat.customer.session" style="height:360px"
                v-scroll-bottom="onlineChat.customer.session.messages">
                <li v-for="(item,key) in onlineChat.customer.session.messages" class="cm-item">
                    <!--æ—¶é—´-->
                    <p class="cm-time"
                       v-if="key==0 || item.ctime-onlineChat.customer.session.messages[key-1].ctime > 60">
                        <span>{{onlineChat.helper.messageFormatTime(item.ctime*1000)}}</span>
                    </p>

                    <div :class="{self:item.uid == onlineChat.userinfo.uid}">
                        <!--å¤´åƒ-->
                        <img class="cm-avatar" width="30" height="30"
                             :src="item.uid == onlineChat.userinfo.uid ? '../static/img/user.png':'../static/img/customer.png'"/>
                        <!--æ–‡æœ¬-->
                        <div v-if="item.msg_type==0" class="cm-msg cm-txt cm-bg-color">
                            {{item.msg}}
                        </div>
                        <!--å¯Œæ–‡æœ¬-->
                        <div v-if="item.msg_type==4" class="cm-msg cm-txt cm-bg-color" v-html="item.msg">
                        </div>
                        <!--å›¾ç‰‡-->
                        <div v-if="item.msg_type==1" class="cm-msg cm-img">
                            <img :src="item.msg" :onload="imgLoadScrollBottom()"/>
                        </div>
                        <!--å£°éŸ³-->
                        <div v-if="item.msg_type==2" class="cm-msg cm-bg-color cm-sound" :sound-src="item.msg.path"
                             :style="{width:parseInt(70+(item.msg.duration * 5)).toString() + 'px'}">
                            <img v-if="item.uid == onlineChat.userinfo.uid" class="sound-img"
                                 src="../static/img/sound1.png"/>
                            <img v-if="item.uid != onlineChat.userinfo.uid" class="sound-img"
                                 src="../static/img/sound.png"/>
                            <span class="sound-duration">{{parseInt(item.msg.duration)}}"</span>
                        </div>
                        <!--è§†é¢‘-->
                        <div v-if="item.msg_type==3" class="cm-msg cm-video" :video-src="item.msg.path">
                            <img :src="onlineChat.httpApiHost+item.msg.video_cover_img" class="video-cover-img"
                                 :onload="imgLoadScrollBottom() />
                                <img src=" ../static/img/play.png" class="video-play-img"/>
                        </div>
                        <!--æ–‡ä»¶-->
                        <div v-if="item.msg_type==5" class="cm-msg cm-file">
                            <div class="mf-left">
                                <img src="../static/img/file.jpg"/>
                            </div>
                            <div class="mf-right">
                                <p class="mf-filename">{{item.msg.filename}}</p>
                                <p class="mf-detail">
                                    <span class="mf-size">{{onlineChat.helper.formatFilesize(item.msg.filesize)}}</span>
                                    <span class="mf-download"><a
                                            :href="onlineChat.helper.getFileDownloadUrl(item.msg.path,item.msg.filename)"
                                            target="_bank" style="color:#35ac2f;text-decoration: none">ä¸‹è½½</a></span>
                                </p>
                            </div>
                        </div>

                    </div>
                </li>
            </ul>
        </div>

        <div class="chat-message-editor">
            <div name="msg" placeholder="è¯·è¾“å…¥å†…å®¹" id="editor"></div>
        </div>

        <div class="chat-message-tool" style="z-index:100000">
            <button onClick="connect()">è¿æ¥</button>
            <button onclick="sendMsg()">å‘é€</button>
        </div>

    </div>
</div>

<audio controls style="display:none" id="online-sound">
    <source src="../static/mp3/online.mp3" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ audio å…ƒç´ ã€‚
</audio>
<audio controls style="display:none" id="chat-sound">
    <source src="" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ audio å…ƒç´ ã€‚
</audio>
</body>
<script>

    function updateValue() {
        $("#url").val($("#select").val())
        connect();
    }


    //æœ¬æœåŠ¡çš„å®¢æˆ·ç«¯
    var socketLocal;
    //è¿æ¥çš„å®¢æˆ·ç«¯
    var socket;

    function upload(event) {

        var a = $("#url").val();
        var b = a.split(":")[1];
        var c = b.replace("//", "");
        var d = "http://" + c + ":8090/netty/upload";

        console.log(d)
        const formData = new FormData();
        formData.append('file', event.target.files[0]);
        fetch(d, {
            method: 'post',
            body: formData,
        }).then(response => response.json())
            .then((data) => {
                $("#localDiv").append("æˆ‘ï¼šæ–‡ä»¶å‘é€æˆåŠŸï¼Œåœ°å€ï¼š" + data.data[0] + "<br/>")
                socket.send("æ”¶åˆ°æ–°æ–‡ä»¶ï¼Œå·²ä¿å­˜åˆ°ï¼š" + data.data[0]);
            });
    }

    connectLocal();

    if (!window.WebSocket) {
        window.WebSocket = window.MozWebSocket;
    }

    function connect() {

        if (window.WebSocket) {

            var socketUrl = "ws://" + $("#url").val() + ":8888/ws/chat";

            socket = new WebSocket(socketUrl);
            socket.onmessage = function (event) {
                console.log("æ”¶åˆ°æœåŠ¡ç«¯çš„æ¶ˆæ¯", event.data);
                $("#localDiv").append("<div><div style='float: right'><span>ä»–ï¼š" + event.data + "</span></div></div><br/>")
            };
            socket.onopen = function (event) {
                console.log("ä¸å¯¹æ–¹é“¾æ¥æˆåŠŸ!  \r\n")
                $("#localDiv").append("ä¸å¯¹æ–¹é“¾æ¥æˆåŠŸ! <br/>")
            };
            socket.onclose = function (event) {
                console.log("å¯¹æ–¹ä¸åœ¨çº¿ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å…³é—­ \r\n")
                $("#localDiv").append("å¯¹æ–¹ä¸åœ¨çº¿ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å…³é—­ <br/>")
            };
        } else {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®ï¼");
        }
    }

    //è¿æ¥æœ¬æœåŠ¡
    function connectLocal() {
        if (window.WebSocket) {
            socketLocal = new WebSocket("ws://localhost:8888/ws/chat");
            socketLocal.onmessage = function (event) {

                var data = event.data
                console.log("æ”¶åˆ°æœ¬æœåŠ¡ç«¯å‘é€ç»™è‡ªå·±çš„æ¶ˆæ¯", data);

                try {
                    var arr = JSON.parse(data);
                    if ((typeof arr == 'object') && arr.constructor == Array) {
                        var obj = document.getElementsByTagName("select")[0];
                        var selectOptions = obj.options;
                        var optionLength = selectOptions.length;
                        for (var i = 0; i < optionLength; i++) {
                            obj.removeChild(selectOptions[0]);
                        }
                        for (let i = 0; i < arr.length; i++) {
                            $("#select").append("<option id='option' value='" + arr[i] + "'>" + arr[i] + "</option>")
                        }
                    } else {
                        $("#localDiv").append("å¯¹æ–¹ï¼š" + event.data + "<br/>")
                    }
                } catch (e) {
                    $("#localDiv").append("å¯¹æ–¹ï¼š" + event.data + "<br/>")
                }

            };
            socketLocal.onopen = function (event) {

                console.log("ç³»ç»Ÿæ¶ˆæ¯ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡é“¾æ¥æˆåŠŸ!\r\n")
                $("#localDiv").append("<div><div style='float: right'><span>ç³»ç»Ÿæ¶ˆæ¯ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡é“¾æ¥æˆåŠŸ!</span></div></div><br/><br/>")


            };
            socketLocal.onclose = function (event) {
                console.log("ç³»ç»Ÿæ¶ˆæ¯ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡è¿æ¥å¤±è´¥ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚é“¾æ¥å·²å…³é—­ \r\n")
                $("#localDiv").append("<div><div style='float: right'><span>ç³»ç»Ÿæ¶ˆæ¯ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡è¿æ¥å¤±è´¥ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚é“¾æ¥å·²å…³é—­</span></div></div><br/><br/>")
            };
        } else {
            alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWebSocketåè®®ï¼");
        }
    }

    //å®ä¾‹åŒ–sdk
    var onlineChat = new online_chat_js_sdk({
        httpApiHost: '',
        noLoginJumpUrl: 'index.html',
        alertMsg: function (msg) {
            layer.msg(msg);
        }
    });
    var vm = new Vue({
        el: '#app',
        data: {
            // å½“å‰ç”¨æˆ·
            onlineChat: onlineChat,
            sideTab: 'session'
        },
        methods: {
            joinSession: function (contactIndex) {
                onlineChat.joinSession(contactIndex);
                this.sideTab = 'session';
            },
            'last_msg': function (message) {
                if (message != null && message != '') {
                    if (message.name == null) {
                        message.name = '';
                    }
                    var msg = message.msg;
                    if (message.msg_type == onlineChat.MSG_TYPE_IMG) {
                        msg = '[å›¾ç‰‡]';
                    } else if (message.msg_type == onlineChat.MSG_TYPE_VIDEO) {
                        msg = '[è§†é¢‘]';
                    } else if (message.msg_type == onlineChat.MSG_TYPE_SOUND) {
                        msg = '[éŸ³é¢‘]';
                    } else if (message.msg_type == onlineChat.MSG_TYPE_FILE) {
                        msg = '[æ–‡ä»¶]';
                    }
                    if (message.uid != onlineChat.userinfo.uid) {
                        if (message.msg_type == onlineChat.MSG_TYPE_RICH_TXT) {
                            return '<p>[' + message.name + ']:' + msg.substr(3);
                        } else {
                            return '[<span>' + message.name + '</span>]ï¼š' + msg;
                        }
                    } else {
                        return msg;
                    }
                } else {
                    return '';
                }
            },
            imgLoadScrollBottom: function () {
                setTimeout(function () {
                    var elem = document.getElementById('chat-message');
                    var scrollTop = elem.scrollHeight - elem.clientHeight;
                    $(elem).slimScroll({scrollTo: scrollTop.toString() + 'px'});
                    elem.scrollTop = elem.scrollHeight - elem.clientHeight;
                }, 100);
            }
        },
        directives: {
            // å‘é€æ¶ˆæ¯åæ»šåŠ¨åˆ°åº•éƒ¨
            'scroll-bottom': function () {
                if (typeof this.vm != "undefined") {
                    this.vm.$nextTick(function () {
                        var elem = document.getElementById('chat-message');
                        var scrollTop = elem.scrollHeight - elem.clientHeight;
                        $(elem).slimScroll({scrollTo: scrollTop.toString() + 'px'});
                        elem.scrollTop = elem.scrollHeight - elem.clientHeight;
                    });
                }
            }
        },
        mounted: function () {
            this.$nextTick(function () {
                // Code that will run only after the
                // entire view has been rendered
            });
        }
    });
    onlineChat.startTmp();

    //å‘é€æ¶ˆæ¯
    function sendMsg() {
        var message = editor.txt.html();
        var lines = editor.txt.getJSON();

        if (/<img[^>]*>/.test(message) || /<br\/>/.test(message) || lines.length > 1) {
            var message = editor.txt.html();
            var msg_type = onlineChat.MSG_TYPE_RICH_TXT;
        } else {
            var message = editor.txt.text();
            var msg_type = onlineChat.MSG_TYPE_TXT;
        }
        if (message == '') {
            alert('æ¶ˆæ¯ä¸èƒ½ä¸ºç©ºï¼');
            return;
        }

        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
            $("#localDiv").append("<div><div style='float: right'><span>æˆ‘ï¼š" + message + "</span></div></div><br/><br/>")
            //æ¸…ç©ºæ¶ˆæ¯
            editor.txt.html("");
        } else {
            alert("WebSocket è¿æ¥æ²¡æœ‰å»ºç«‹æˆåŠŸï¼");
        }

    }

    $(function () {
        $('.list').slimScroll({
            height: '460px'
        });
        $('.chat-message').slimScroll({
            height: '360px'
        });
        $('.w-e-text').slimScroll({
            height: '90px'
        });
    });

    var E = window.wangEditor;
    var editor = new E('#editor');
    // è‡ªå®šä¹‰èœå•é…ç½®
    editor.customConfig.menus = [
        'emoticon',  // è¡¨æƒ…
    ];

    editor.customConfig.emotions = [
        // {
        //     // tab çš„æ ‡é¢˜
        //     title: 'é»˜è®¤',
        //     // type -> 'emoji' / 'image'
        //     type: 'image',
        //     // content -> æ•°ç»„
        //     content: onlineChatFaceImgs
        // },
        {
            // tab çš„æ ‡é¢˜
            title: 'emoji',
            // type -> 'emoji' / 'image'
            type: 'emoji',
            // content -> æ•°ç»„
            content: 'ğŸ˜€ ğŸ˜ƒ  ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ˜Š ğŸ˜‡ ğŸ™‚ ğŸ™ƒ ğŸ˜‰ ğŸ˜Œ ğŸ˜ ğŸ˜˜ ğŸ˜— ğŸ˜™ ğŸ˜š ğŸ˜‹ ğŸ˜œ ğŸ˜ ğŸ˜ ğŸ˜’ ğŸ˜ ğŸ˜” ğŸ˜Ÿ ğŸ˜• ğŸ˜£ ğŸ˜– ğŸ˜« ğŸ˜© ğŸ˜¤ ğŸ˜  ğŸ˜¶ ğŸ˜ ğŸ˜‘ ğŸ˜¯ ğŸ˜¦ ğŸ˜§ ğŸ˜® ğŸ˜² ğŸ˜µ ğŸ˜³ ğŸ˜± ğŸ˜¨ ğŸ˜° ğŸ˜¢ ğŸ˜¥ ğŸ˜­ ğŸ˜“ ğŸ˜ª ğŸ˜´ ğŸ™„ ğŸ¤” ğŸ˜¬ ğŸ¤'.split(/\s/)
        },
        {
            // tab çš„æ ‡é¢˜
            title: 'emojiæ‰‹åŠ¿',
            // type -> 'emoji' / 'image'
            type: 'emoji',
            // content -> æ•°ç»„
            content: ['ğŸ™Œ', 'ğŸ‘', 'ğŸ‘‹', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ï¸ğŸ‘Œ', 'âœ‹', 'ğŸ‘', 'ğŸ’ª', 'ğŸ™', 'ï¸ğŸ‘†', 'ğŸ‘‡', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ–•', 'ğŸ–', 'ğŸ¤˜']
        }
    ]
    editor.create();


    //ä¸Šä¼ æ–‡ä»¶
    // $('.w-e-toolbar').append('<div class="w-e-menu" id="upload"><i class="w-e-icon-file"></i><input type="file" name="file"></div>');
    $('.w-e-toolbar').append('<div class="w-e-menu" id="upload"><i class="w-e-icon-file"></i><input type="file" id="files" onchange="upload(event)"/></div>');


    $('body').on('click', '.cm-img img', function () {
        var index = 0;
        var imgs = [];
        for (var i = 0; i < onlineChat.customer.session.messages.length; i++) {
            if (onlineChat.customer.session.messages[i].msg_type == onlineChat.MSG_TYPE_IMG) {
                if (onlineChat.customer.session.messages[i].msg == $(this).attr('src')) {
                    index = imgs.length;
                }
                imgs.push({
                    "alt": "",
                    "pid": i, //å›¾ç‰‡id
                    "src": onlineChat.customer.session.messages[i].msg, //åŸå›¾åœ°å€
                    "thumb": "" //ç¼©ç•¥å›¾åœ°å€
                });
            }
        }
        //console.log(imgs);
        layer.photos({
            photos: {
                "title": "", //ç›¸å†Œæ ‡é¢˜
                "id": 123, //ç›¸å†Œid
                "start": index, //åˆå§‹æ˜¾ç¤ºçš„å›¾ç‰‡åºå·ï¼Œé»˜è®¤0
                "data": imgs
            }
            , anim: 5 //0-6çš„é€‰æ‹©ï¼ŒæŒ‡å®šå¼¹å‡ºå›¾ç‰‡åŠ¨ç”»ç±»å‹ï¼Œé»˜è®¤éšæœº
            , shade: [0.9, '#000']
            , closeBtn: true
        });
    });
    $('body').on('click', '.cm-sound', function () {
        var sound_src = $(this).attr('sound-src');
        $('#chat-sound').attr('src', sound_src);
        $("#chat-sound")[0].play();
    });
    $('body').on('click', '.cm-video', function () {
        var video_src = $(this).attr('video-src');
        layer.open({
            title: false,
            type: 1,
            skin: 'layui-layer-demo', //æ ·å¼ç±»å
            closeBtn: 0, //ä¸æ˜¾ç¤ºå…³é—­æŒ‰é’®
            area: ['auto', 'auto'],
            anim: 2,
            shadeClose: true, //å¼€å¯é®ç½©å…³é—­
            content: '<video width="800px" height="600px" controls="controls" autoplay="autoplay" style="background:#000"><source src="' + video_src + '" type="video/mp4" /></video>'
        });
    });
    $('body').on('change', '#upload input[type=file]', function () {

        if (typeof onlineChat.customer.session.uid == 'undefined') {
            //alert('è¯·é€‰æ‹©èŠå¤©');
            return;
        }
        onlineChat.httpApi.uploadFile({
            file: $(this)[0].files[0],
            chat_type: onlineChat.CHAT_TYPE_CUSTOMER
        });
        $('#upload').html($('#upload').html());
    });
    $('.w-e-text').keydown(function (event) {
        if (event.ctrlKey && event.keyCode == 13) {
            if (navigator.userAgent.indexOf("Edge") > -1 || 'ActiveXObject' in window) { //IEæµè§ˆå™¨å’Œedgeæµè§ˆå™¨
                editor.txt.append('<p></p>');
                return false;
            } else {
                editor.txt.append('<p><br></p>');
                return false;
            }
        }
        if (event.keyCode == 13) {
            sendMsg();
            return false;
        }
    });


    $.ajax({
            type: "get",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            url: "http://localhost:8090/netty/selectArrayList",
            success: function (result) {
                if (result.code == 200) {
                    var arrs = result.data;

                    // for(var i in arrs){
                    //     console.dir(i);//è¾“å‡ºå§“å
                    //     console.dir(arrs[i]);//è¾“å‡ºåˆ†æ•°
                    // }

                    for (var i = 0; i < arrs.length; i++) {
                        console.log(arrs[i])
                        $("#select").append("<option value ='" + arrs[i] + "'>" + arrs[i] + "</option>");
                    }

                }

            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert(errorThrown);
            },
            async: false             //falseè¡¨ç¤ºåŒæ­¥
        }
    );


</script>

</html>